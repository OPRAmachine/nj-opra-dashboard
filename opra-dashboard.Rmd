---
title: "OPRA Compliance in New Jersey"
output: 
  flexdashboard::flex_dashboard:
    theme: default
    orientation: rows
    source_code: "https://github.com/gavinrozzi/nj-opra-dashboard"
    vertical_layout: fill
runtime: shiny

---
  
  ```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(plotly)
library(bubbles)

# Read in CSV file of OPRA request data
requests <- read.csv('data/output.csv')

# Request count by authority
authorities <- requests %>% count(vars = requested_from) %>% arrange(desc(n))

# Request count by user
users <- requests %>% count(vars = requested_by) %>% arrange(desc(n))

# Summaries by request state
request_counts <- requests %>% count(vars = described_state) %>% arrange(desc(n))

# Get average response time for authority TODO: move to processing script
#1. Get all requests for that authority
for (i in 1:nrow(authorities)) {
authority_requests <- requests %>% filter(`requested_from` == authorities$vars[i])
authorities$average_response_time[i] <- mean(na.omit(authority_requests$days_until_response))
}

# Get crosswalk of counties to tag names
counties <- read_csv('data/county_to_tag.csv')

```
Home
=====================================

About the Tracker {.sidebar}
-----------------------------------------------------------------------
  
How well are government agencies complying with New Jersey's freedom of information law, the Open Public Records Act?

[OPRAmachine](https://opramachine.com/) has been tracking requests submitted by users since 2017. 
The data displayed in this dashboard was dervied from the website. 
This dashboard does not track all OPRA requests from New Jersey, only those that were submitted via OPRAmachine.

```{r}
dateRangeInput('daterange', 'Filter by date range', start = '2017-10-23', end = NULL, min = NULL,
  max = NULL, format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
```

Column
-----------------------------------------------------------------------

### Total requests

```{r}
renderValueBox({
  total_requests <- nrow(requests)
  valueBox(total_requests , 
           icon = "fa-copy")
})
```


### Public authorities

```{r}
renderValueBox({
  total_auth <- nrow(authorities)
  valueBox(total_auth , 
           icon = "fa-university")
})
```

### OPRA requesters

```{r}
renderValueBox({
  total_users <- nrow(users)
  valueBox(total_users, 
           icon = "fa-user-edit")
})
```

### Average days until response

```{r}
renderValueBox({
  # Remove requests that failed to deliver from average response time calculation
  requests_error_omit <- requests %>% filter(described_state != 'error_message')
  avg_response <- round(mean(na.omit(requests_error_omit$days_until_response)), digits = 2)
  valueBox(avg_response, 
           icon = "fa-clock",
           color = ifelse(avg_response > 7, "warning", "primary"))
})
```


Column 
-----------------------------------------------------------------------

### Successful requests

```{r}
successful <- nrow(requests %>% filter(described_state == 'successful' | described_state == 'partially_successful'))
rate <- round(successful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Answered within 7 business days

```{r}
percent_within_7days <- round(nrow(requests %>% filter(days_until_response < 7)) / nrow(requests) * 100, digits = 2)

gauge(percent_within_7days, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```


### Requests awaiting response

```{r}
awaiting_response <- nrow(requests %>% filter(described_state == 'waiting_response'))
rate <- round(awaiting_response / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests awaiting classification

```{r}
awaiting_classification <- nrow(requests %>% filter(awaiting_description == 'TRUE'))
rate <- round(awaiting_classification / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Unsuccessful requests

```{r}
unsuccessful <- nrow(requests %>% filter(described_state == 'rejected' | described_state == 'not_held'))
rate <- round(unsuccessful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```


Row 
-----------------------------------------------------------------------

### Authorities with the most requests

```{r}
# Get top 10 authorities by request count
top10 <- authorities %>% top_n(10, wt=n) %>% arrange(desc(n))

# Make an ordered factor
top10$vars <- factor(top10$vars, levels = top10$vars)

# Plot them with Plotly
fig <- plot_ly(
  x = top10$vars,
  y = top10$n,
  name = "Requests by authority",
  type = "bar"
)
fig
  
```


### Request states on OPRAmachine

```{r}
# Get top 10 authorities TODO: replace this graph with a county choropleth
top10 <- authorities %>% top_n(10)
#top10 <- na.omit(top25[ -c(1) ])

# Make an ordered factor

# Plot them with Plotly
fig <- request_counts %>% plot_ly(labels=~vars, values=~n)
fig <- fig %>% add_pie(hole = 0.6)
fig
  
```


### Slowest to respond

```{r}
# Get top 10 slowest authorities
top10times <- authorities %>% top_n(10, wt=average_response_time) %>% arrange(desc(average_response_time))

# Make an ordered factor
top10times$vars <- factor(top10$vars, levels = top10$vars)

# Plot them with Plotly
fig <- plot_ly(
  x = top10times$vars,
  y = top10times$average_response_time,
  name = "Top 10 longest to respond",
  type = "bar",
)
fig
```

Row
-----------------------------------------------------------------------


By County
=====================================

Compare by County {.sidebar}
-----------------------------------------------------------------------
How do New Jersey's counties compare for OPRA response times?

```{r}
selectInput("county_name", "County Name", choices = counties$Name)
#reactive({
#filter_tag <- counties %>% filter(Name == toString(input$county_name))
#input$county_tag < - filter_tag$Tag
#})

```

Row
-----------------------------------------------------------------------

### Average days until response for this county

```{r}

# Get just the requests for Ocean County reapl with toString(input$county_name)

county_requests <- requests %>% filter(str_detect(tag_string, 'Ocean'))

# Calculate average response time for the county
county_response_time <- mean(na.omit(county_requests$days_until_response))
renderValueBox({
  # Remove requests that failed to deliver from average response time calculation
  requests_error_omit <- requests %>% filter(described_state != 'error_message')
  avg_response <- round(mean(na.omit(requests_error_omit$days_until_response)), digits = 2)
  valueBox(county_response_time, 
           icon = "fa-clock",
           color = ifelse(avg_response > 7, "warning", "primary"))
  })

```

### Average days until response for all requests

```{r}

# Calculations for comparison across counties
county_requests <- requests %>% filter(str_detect(tag_string, "OceanCounty"))
# Calculate average response time for the county
county_response_time <- round(mean(na.omit(county_requests$days_until_response)), digits = 2)

requests_error_omit <- requests %>% filter(described_state != 'error_message')

avg_response <- mean(na.omit(requests_error_omit$days_until_response))

difference <- county_response_time / avg_response * 100
  


renderValueBox({
  # Remove requests that failed to deliver from average response time calculation
  requests_error_omit <- requests %>% filter(described_state != 'error_message')
  avg_response <- round(mean(na.omit(requests_error_omit$days_until_response)), digits = 2)
  valueBox(avg_response, 
           icon = "fa-clock",
           color = ifelse(avg_response > 7, "warning", "primary"))
})
```


By Municipality
=====================================

```{r}
renderBubbles(bubbles(request_counts$n, request_counts$vars))
```

All requests 
=====================================

Row
-----------------------------------------------------------------------


### All OPRA requests
  
  ```{r}
DT::renderDataTable({
  DT::datatable(requests, extensions = 'Responsive', escape = FALSE, rownames = FALSE,
  options = list(
    bPaginate = TRUE
  ))
})
  ```

