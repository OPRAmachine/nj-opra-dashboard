---
title: "OPRA Compliance in New Jersey"
output: 
  flexdashboard::flex_dashboard:
    theme: default
    orientation: rows
    source_code: "https://github.com/gavinrozzi/nj-opra-dashboard"
runtime: shiny

---
  
  ```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)

# Read in CSV files of OPRA request data
authorities <- read.csv('data/authority_summary.csv')
authorities <- authorities[ -c(1) ]
users <- read.csv('data/user_summary.csv')
requests <- read.csv('data/output.csv')
```
Page 1 {data-navmenu="Home"}
=====================================

About the Tracker {.sidebar}
-----------------------------------------------------------------------
  
How well are government agencies complying with New Jersey's freedom of information law, the Open Public Records Act?

[OPRAmachine](https://opramachine.com/) has been tracking requests submitted by users since 2017.

```{r}
dateRangeInput('daterange', 'Filter by date range', start = '2017-10-23', end = NULL, min = NULL,
  max = NULL, format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
```

Column
-----------------------------------------------------------------------

### Total requests

```{r}
renderValueBox({
  total_requests <- nrow(requests)
  valueBox(total_requests , 
           icon = "fa-copy")
})
```


### Public authorities

```{r}
renderValueBox({
  total_auth <- nrow(authorities)
  valueBox(total_auth , 
           icon = "fa-university")
})
```

### OPRA requesters

```{r}
renderValueBox({
  total_users <- nrow(users)
  valueBox(total_users, 
           icon = "fa-user-edit")
})
```

### Average days until response

```{r}
renderValueBox({
  avg_response <- round(mean(na.omit(requests$days_until_response)), digits = 2)
  valueBox(avg_response, 
           icon = "fa-clock",
           color = ifelse(avg_response > 7, "warning", "primary"))
})
```

Column 
-----------------------------------------------------------------------

### Successful requests

```{r}
successful <- nrow(requests %>% filter(described_state == 'successful' | described_state == 'partially_successful'))
rate <- round(successful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests awaiting response

```{r}
awaiting_response <- nrow(requests %>% filter(described_state == 'waiting_response'))
rate <- round(awaiting_response / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests awaiting classification

```{r}
awaiting_classification <- nrow(requests %>% filter(awaiting_description == 'TRUE'))
rate <- round(awaiting_classification / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Unsuccessful requests

```{r}
unsuccessful <- nrow(requests %>% filter(described_state == 'rejected' | described_state == 'not_held'))
rate <- round(unsuccessful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

Row
-----------------------------------------------------------------------


```{r warning=TRUE}
top25 <- authorities %>% top_n(25)
top25 <- top25[order(-authorities$request_count),]
p <- ggplot(top25, aes(authority, request_count)) +geom_bar(stat = "identity")+theme(axis.text.x = element_text(angle = 60, hjust = 1))
renderPlot(p)
  
```

Row
-----------------------------------------------------------------------


### OPRA requests
  
  ```{r}
DT::renderDataTable({
  DT::datatable(requests, extensions = 'Responsive', escape = FALSE, rownames = FALSE,
  options = list(
    bPaginate = TRUE
  ))
})
  ```

