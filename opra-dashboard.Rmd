---
title: "OPRA Compliance in New Jersey"
output: 
  flexdashboard::flex_dashboard:
    theme: default
    orientation: rows
    source_code: "https://github.com/gavinrozzi/nj-opra-dashboard"
    vertical_layout: fill
runtime: shiny

---
  
  ```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(plotly)

# Read in CSV files of OPRA request data
authorities <- read.csv('data/authority_summary.csv')
authorities <- authorities[ -c(1) ]
users <- read.csv('data/user_summary.csv')
requests <- read.csv('data/output.csv')
```
Page 1 {data-navmenu="Home"}
=====================================

About the Tracker {.sidebar}
-----------------------------------------------------------------------
  
How well are government agencies complying with New Jersey's freedom of information law, the Open Public Records Act?

[OPRAmachine](https://opramachine.com/) has been tracking requests submitted by users since 2017.

```{r}
dateRangeInput('daterange', 'Filter by date range', start = '2017-10-23', end = NULL, min = NULL,
  max = NULL, format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
```

Column
-----------------------------------------------------------------------

### Total requests

```{r}
renderValueBox({
  total_requests <- nrow(requests)
  valueBox(total_requests , 
           icon = "fa-copy")
})
```


### Public authorities

```{r}
renderValueBox({
  total_auth <- nrow(authorities)
  valueBox(total_auth , 
           icon = "fa-university")
})
```

### OPRA requesters

```{r}
renderValueBox({
  total_users <- nrow(users)
  valueBox(total_users, 
           icon = "fa-user-edit")
})
```

### Average days until response

```{r}
renderValueBox({
  # Remove requests that failed to deliver from average response time calculation
  requests_error_omit <- requests %>% filter(described_state != 'error_message')
  avg_response <- round(mean(na.omit(requests_error_omit$days_until_response)), digits = 2)
  valueBox(avg_response, 
           icon = "fa-clock",
           color = ifelse(avg_response > 7, "warning", "primary"))
})
```


Column 
-----------------------------------------------------------------------

### Successful requests

```{r}
successful <- nrow(requests %>% filter(described_state == 'successful' | described_state == 'partially_successful'))
rate <- round(successful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests answered within 7 business days

```{r}
percent_within_7days <- round(nrow(requests %>% filter(days_until_response < 7)) / nrow(requests) * 100, digits = 2)

gauge(percent_within_7days, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests awaiting response

```{r}
awaiting_response <- nrow(requests %>% filter(described_state == 'waiting_response'))
rate <- round(awaiting_response / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Requests awaiting classification

```{r}
awaiting_classification <- nrow(requests %>% filter(awaiting_description == 'TRUE'))
rate <- round(awaiting_classification / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

### Unsuccessful requests

```{r}
unsuccessful <- nrow(requests %>% filter(described_state == 'rejected' | described_state == 'not_held'))
rate <- round(unsuccessful / nrow(requests) * 100, digits = 2)

gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```

Row {data-height=350}
-----------------------------------------------------------------------

```{r}
# Get top 10 authorities
top10 <- authorities %>% top_n(10)
#top10 <- na.omit(top25[ -c(1) ])

# Make an ordered factor
top10$authority <- factor(top10$authority, levels = top10$authority)

# Plot them with Plotly
fig <- plot_ly(
  x = top10$authority,
  y = top10$request_count,
  name = "Requests by authority",
  type = "bar"
)
fig %>%
    layout(title = 'Top 10 Authorities by request count', margin = list(b = 220), xaxis = list(tickangle = 45))
  
```


```{r}
# Get top 10 authorities TODO: replace this graph with a county choropleth
top10 <- authorities %>% top_n(10)
#top10 <- na.omit(top25[ -c(1) ])

# Make an ordered factor
top10$authority <- factor(top10$authority, levels = top10$authority)

# Plot them with Plotly
fig <- plot_ly(
  x = top10$authority,
  y = top10$request_count,
  name = "Requests by authority",
  type = "bar"
)
fig %>%
    layout(title = 'Top 10 Authorities by request count', margin = list(b = 220), xaxis = list(tickangle = 45))
  
```

```{r}
# Get top 10 authorities
top10 <- authorities %>% top_n(10)
#top10 <- na.omit(top25[ -c(1) ])

# Make an ordered factor
top10$authority <- factor(top10$authority, levels = top10$authority)

# Plot them with Plotly
fig <- plot_ly(
  x = top10$authority,
  y = top10$request_count,
  name = "Requests by authority",
  type = "bar"
)
fig %>%
    layout(title = 'Top 10 Authorities by request count', margin = list(b = 220), xaxis = list(tickangle = 45))
  
```

Row
-----------------------------------------------------------------------

Row
-----------------------------------------------------------------------


### OPRA requests
  
  ```{r}
DT::renderDataTable({
  DT::datatable(requests, extensions = 'Responsive', escape = FALSE, rownames = FALSE,
  options = list(
    bPaginate = TRUE
  ))
})
  ```

